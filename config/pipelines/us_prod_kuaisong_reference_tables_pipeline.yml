# US Production Kuaisong Reference Tables Pipeline (v1.2.0)
# Daily full sync for reference/dimension tables
# Sync frequency: Daily at 2 AM (0 2 * * *)

pipeline:
  name: "us_prod_kuaisong_reference_tables"
  description: "US Production Kuaisong reference tables - daily full sync"
  source: "US_PROD_RO_SSH"         # US Production (us-west-2) with SSH tunnel
  target: "redshift_default"       # QA Redshift cluster
  version: "1.2.0"                 # v1.2.0 CDC Intelligence Engine
  sync_frequency: "0 2 * * *"      # Daily at 2 AM
  
  processing:
    strategy: "sequential"         # Use sequential like the working pipeline
    batch_size: 50000             # Larger batches for full sync
    timeout_minutes: 30           # 30 minutes for all tables
    max_parallel_tables: 1        # Sequential processing
  
  s3:
    isolation_prefix: "us_prod_kuaisong_reference/"
    partition_strategy: "table"    # Better for full sync - groups all table files together
    compression: "snappy"
  
  # Reference tables use full_sync strategy
  cdc_settings:
    default_strategy: "full_sync"  # Full table sync strategy
    enable_watermark_validation: false  # No watermarks for full sync
    enable_schema_validation: true
    fallback_to_legacy: false     # Use v1.2.0 full sync features

# Table configurations for reference tables
tables:
  # 1. Warehouses - ~1K rows (MEDIUM priority)
  kuaisong.uni_warehouses:
    cdc_strategy: "full_sync"
    full_sync_mode: "replace"        # TRUNCATE table before loading (dimension refresh)
    description: "Warehouse master data - dimension table"
    target_name: "uni_warehouses_ref"
    
    processing:
      batch_size: 50000              # Single batch for small table
      enable_parallel_processing: false
      
  # 2. Customer - ~10K rows (MEDIUM priority)
  kuaisong.uni_customer:
    cdc_strategy: "full_sync"
    full_sync_mode: "replace"        # TRUNCATE table before loading
    description: "Customer master data - dimension table"
    target_name: "uni_customer_ref"
    
    processing:
      batch_size: 50000
      enable_parallel_processing: false
      
  # 3. Prealert Info - ~50K rows (MEDIUM priority)
  kuaisong.uni_prealert_info:
    cdc_strategy: "full_sync"
    full_sync_mode: "replace"        # TRUNCATE table before loading
    description: "Prealert info reference data"
    target_name: "uni_prealert_info_ref"
    
    processing:
      batch_size: 50000
      enable_parallel_processing: false
      
  # 5. ECS Staff - ~500 rows (LOW priority)
  kuaisong.ecs_staff:
    cdc_strategy: "full_sync"
    full_sync_mode: "replace"        # TRUNCATE table before loading
    description: "Staff master data - dimension table"
    target_name: "ecs_staff_ref"
    
    processing:
      batch_size: 50000
      enable_parallel_processing: false
      
    # Schema handled automatically by existing conversion logic
    validation:
      enable_schema_validation: true
      create_table_if_missing: true   # Auto-create table with correct schema
      enable_data_quality_checks: false  # Skip DQ for reference table
      decimal_columns:
        - latitude
        - longitude
        - rocket_pay
        - night_pay
        - duty_pay
        - loan_pay
        - carry_pay
        - newdriver_pay
      
  # 6. MAWB Box - ~10K rows (LOW priority)
  kuaisong.uni_mawb_box:
    cdc_strategy: "full_sync"
    full_sync_mode: "replace"        # TRUNCATE table before loading
    description: "MAWB box reference data"
    target_name: "uni_mawb_box_ref"
    
    processing:
      batch_size: 50000
      enable_parallel_processing: false

# Common settings for all reference tables
default_table_config:
  backup_strategy: "sequential"
  watermark_strategy: "automatic"
  
  performance:
    memory_limit_mb: 512            # Lower memory for smaller tables
    connection_timeout: 30          # 30 second connection timeout
    query_timeout: 120              # 2 minute query timeout (full table)
    read_timeout: 90                # 90 second read timeout
    
  # Production database protection
  production_safety:
    max_query_time_seconds: 120     # 2 minutes for full table scans
    use_read_uncommitted: true      # Reduce lock contention
    enable_query_hints: true        # Use hints for better performance
    
  monitoring:
    enable_progress_tracking: true
    enable_performance_metrics: true
    alert_on_failures: true